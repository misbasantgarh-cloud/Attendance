<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NRLM Attendance</title>

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px }
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 15px #0001 }
button { padding:10px; border:none; border-radius:8px; margin:5px; background:#2e7d32; color:#fff }
input, textarea { width:100%; padding:10px; margin:5px 0 }
.hidden { display:none }
</style>
</head>

<body>

<div class="card">
  <h3>ğŸ” Login</h3>
  <input id="mobile" placeholder="Mobile number">
  <button onclick="login()">Login</button>
</div>

<div id="cadre" class="card hidden">
  <h3>ğŸ‘· Cadre Panel</h3>
  <button onclick="mark('IN')">IN</button>
  <button onclick="mark('OUT')">OUT</button>

  <h4>Apply Leave</h4>
  <input id="from" type="date">
  <input id="to" type="date">
  <textarea id="reason" placeholder="Reason"></textarea>
  <button onclick="applyLeave()">Apply Leave</button>
</div>

<div id="bpm" class="card hidden">
  <h3>ğŸ“‹ BPM Panel</h3>
  <button onclick="loadLeaves()">View Leaves</button>
  <div id="leaves"></div>
</div>

<div id="block" class="card hidden">
  <h3>ğŸ¢ Block Panel</h3>
  <button onclick="loadLeaves()">View All Leaves</button>
  <div id="leavesBlock"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyUyilDFQ1wOip8UJRW7KYJREiXXfjsU6_o7QwfyW6BF5FnOIMRWotRsuIEnLSo3rejBw/exec";
let user = {};

function login() {
  fetch(API, {
    method:"POST",
    body:JSON.stringify({ action:"login", mobile: mobile.value })
  }).then(r=>r.json()).then(d=>{
    if(d.error) return alert(d.error);
    user=d;
    document.querySelectorAll(".hidden").forEach(x=>x.style.display="none");
    if(d.role==="CADRE") cadre.style.display="block";
    if(d.role==="BPM") bpm.style.display="block";
    if(d.role==="BLOCK") block.style.display="block";
  });
}

function mark(type){
  navigator.geolocation.getCurrentPosition(p=>{
    fetch(API,{method:"POST",body:JSON.stringify({
      action:"markAttendance",
      ...user,
      type,
      lat:p.coords.latitude,
      lng:p.coords.longitude
    })}).then(r=>r.json()).then(d=>alert(d.message));
  });
}

function applyLeave(){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"applyLeave",
    ...user,
    from:from.value,
    to:to.value,
    reason:reason.value
  })}).then(r=>r.json()).then(d=>alert(d.message));
}

function loadLeaves(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"getLeaves"})})
  .then(r=>r.json()).then(rows=>{
    leaves.innerHTML="";
    rows.forEach(r=>{
      leaves.innerHTML+=`
        <div>
          ${r[2]} (${r[3]} to ${r[4]}) - ${r[6]}
          <button onclick="decide('${r[0]}','APPROVED')">âœ”</button>
          <button onclick="decide('${r[0]}','REJECTED')">âœ–</button>
        </div>`;
    });
  });
}

function decide(id,decision){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"decideLeave",
    id,
    decision,
    by:user.role
  })}).then(()=>alert("Updated"));
}
</script>

</body>
</html>
